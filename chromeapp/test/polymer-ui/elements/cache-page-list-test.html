<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../../../web-component-tester/browser.js"></script>

    <!-- Step 1: import the element to test -->
    <link rel="import" href="../../../app/polymer-ui/elements/cache-page-list.html">
  </head>
  <body>

    <!-- You can use the document as a place to set up your fixtures. -->
    <test-fixture id="cpl-fixture">
      <template is="dom-template">
        <cache-page-list
          service-name="{{serviceName}}">
        <cache-page-list>
      </template>
    </test-fixture>

    <script>
      suite('<cache-page-list>', function() {

        var myEl;

        var serviceName = 'Example Cache._semcache._tcp.local';
        var boundData = {
          serviceName: serviceName
        };

        // A mock result from a call to resolveCache
        var cacheInfo = {
          domainName: 'laptop.local',
          friendlyName: 'My Cache',
          instanceName: 'My Cache._semcache._tcp.local',
          ipAddress: '1.2.3.4',
          port: 1111,
          listUrl: 'http://1.2.3.4:1111/list_pages'
        };

        // Testing of iron-ajax is based on this excellent video from the
        // Polymer team: https://www.youtube.com/watch?v=_9qARcdCAn4
        var responseHeaders = {
          json: { 'Content-Type': 'application/json' }
        };

        // An example result we might expect from listUrl
        var cacheJson = {
          metadata: { version: 0 },
          cachedPages: [
            {
              captureUrl: 'url0.com',
              captureDate: 'date0',
              accessPath: 'access/path/for/url0.mhtml',
              metadata: { mdata: 'mdata0' }
            },
            {
              captureUrl: 'url1.com',
              captureDate: 'date1',
              accessPath: 'access/path/for/url1.mhtml',
              metadata: { mdata: 'mdata1' }
            }
          ]
        };

        var resolveCacheSpy = sinon.stub();
        resolveCacheSpy.withArgs(serviceName).returns(
          Promise.resolve(cacheInfo)
        );
        var getAppControllerModuleSpy = sinon.stub().returns({
          resolveCache: resolveCacheSpy
        });

        setup(function() {
          myEl = fixture('cpl-fixture', boundData);
          myEl.getAppControllerModule = getAppControllerModuleSpy;
        });

        test('has serviceName value', function() {
          assert.equal(myEl.serviceName, serviceName);
        });

        test('refresh correct for success', function(done) {
          // We should show and hide the loading animation
          var showLoadingSpy = sinon.stub();
          var hideLoadingSpy = sinon.stub();
          myEl.showLoading = showLoadingSpy;
          myEl.hideLoading = hideLoadingSpy;

          var server = sinon.fakeServer.create();
          server.respondWith(
            'GET',
            cacheInfo.listUrl,
            [
              200,
              responseHeaders.json,
              JSON.stringify(cacheJson)
            ]
          );
          // Given that our functionality is included within a promise, we
          // can't rely on the server.respond() function
          server.respondImmediately = true;

          myEl.refresh()
            .then(() => {
              var ajaxAssertionsComplete = false;
              var promiseAssertionsComplete = false;
              
              assert.equal(showLoadingSpy.callCount, 1);
              assert.equal(hideLoadingSpy.callCount, 1);

              // Refresh set set up the url property
              assert.equal(myEl.url, cacheInfo.listUrl);
              promiseAssertionsComplete = true;

              // We should have generated a request, but this executes
              // asynchronously. Listen to the 'response' event, which will
              // fire upon completion and do our assertions there.
              myEl.$.ajax.addEventListener('response', function() {
                assert.deepEqual(myEl.$.ajax.lastResponse, cacheJson);

                // Ideally here we would like to make sure we have two
                // cached-page-summary nodes, but I'm struggling to access
                // these via the DOM api, so for now I'm ignoring them.
                // var els = myEl.$$('cached-page-summary');
                // var els =
                // Polymer.dom(myEl.root).querySelectorAll('.pagesummary');

                ajaxAssertionsComplete = true;

                if (ajaxAssertionsComplete && promiseAssertionsComplete) {
                  done();
                }
              });

              // We should have populated the response pages
              if (ajaxAssertionsComplete && promiseAssertionsComplete) {
                done();
              }
            });
        });

        test('hides loading if resolve cache errors', function(done) {
          // We should show and hide the loading animation
          var showLoadingSpy = sinon.stub();
          var hideLoadingSpy = sinon.stub();
          myEl.showLoading = showLoadingSpy;
          myEl.hideLoading = hideLoadingSpy;

          var resolveCacheSpy = sinon.stub();
          resolveCacheSpy.returns(Promise.reject('expected err for test'));

          getAppControllerModuleSpy = sinon.stub().returns({
            resolveCache: resolveCacheSpy
          });
          myEl.getAppControllerModule = getAppControllerModuleSpy;

          myEl.refresh()
            .then(() => {
              assert.equal(showLoadingSpy.callCount, 1);
              assert.equal(hideLoadingSpy.callCount, 1);

              done();
            });
        });

        test('hides loading if no list url', function(done) {
          // We should show and hide the loading animation
          var showLoadingSpy = sinon.stub();
          var hideLoadingSpy = sinon.stub();
          myEl.showLoading = showLoadingSpy;
          myEl.hideLoading = hideLoadingSpy;

          var resolveCacheSpy = sinon.stub();
          resolveCacheSpy.returns(Promise.resolve({ weird: 'object' }));

          getAppControllerModuleSpy = sinon.stub().returns({
            resolveCache: resolveCacheSpy
          });
          myEl.getAppControllerModule = getAppControllerModuleSpy;

          myEl.refresh()
            .then(() => {
              assert.equal(showLoadingSpy.callCount, 1);
              assert.equal(hideLoadingSpy.callCount, 1);

              done();
            });
        });
      });
    </script>

  </body>
</html>
